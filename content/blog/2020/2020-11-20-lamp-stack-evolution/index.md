---
layout: post
title: "LAMP stack evolution: From virtual machines to serverless with AWS Amplify and AWS AppSync"
date: 2020-11-20
comments: true
author: Irina Geiman
authorAvatar: ''
bio: ""
published: true
authorIsRacker: true
categories:
    - AWS
metaTitle: "LAMP stack evolution: From virtual machines to serverless with AWS Amplify and AWS AppSync"
metaDescription: "Imagine a scenario where you have worked for high tech companies over the
last 20 years, dealt with IT and cloud infrastructure issues for the last 5
years, and you love designing and deploying elegant solutions on AWS cloud."
ogTitle: "LAMP stack evolution: From virtual machines to serverless with AWS Amplify and AWS AppSync"
ogDescription: "Imagine a scenario where you have worked for high tech companies over the
last 20 years, dealt with IT and cloud infrastructure issues for the last 5
years, and you love designing and deploying elegant solutions on AWS cloud."
slug: "lamp-stack-evolution-from-virtual-machines-to-serverless"
canonical: https://onica.com/blog/serverless/lamp-stack-evolution-from-virtual-machines-to-serverless-with-aws-amplify-and-aws-appsync/

---

*Originally published on November 1, 2019 at Onica.com/blog*

Imagine a scenario where you have worked for high tech companies over the
last 20 years, dealt with IT and cloud infrastructure issues for the last five
years, and you love designing and deploying elegant solutions on the AWS cloud.

<!--more-->

*Disclaimer: I’m a Lead Solutions Architect at Onica, an APN Premier Consulting Partner, and for the
purpose of this blog, I'm playing the parts of both the imaginary business owner and the service provider.*

To add to this, you are a woman who loves creating elaborate nail polish
designs. The next logical step in this situation seems obvious&mdash;combine the
two passions and create a website that runs in the cloud and features my
nail polish designs. In an ideal world, I would be running my own nail polish
salon business and would commission such a site from an external service
provider (I would be too busy creating beautiful designs). I would expect
the site to help me with my business challenges while adhering to the principles
of well-architected cloud design.

To ensure my business continuity and profitability, the solution should be:

- Highly available
- Scalable
- Run on web and mobile platforms
- Cost-effective in terms of development, maintenance, and infrastructure
- Able to support different types of users, such as designers, customers, or visitors
- Provide actionable insights from the data generated by my customers
- Automate routine work related to site maintenance
- Easily updatable
- Easily extendable globally

The site should be relatively simple. My designers upload the images they
want to showcase, and the customers comment on the designs with their comments
visible to the site admins only. The automation of business processes
combined with user input analytics is our business differentiator.

Based on this wish list, the service provider has come up with multiple
options. Let’s dive into each one to see how it stacks up against my
requirements for the solution.

### Design option 1: LAMP stack

The initial AWS infrastructure design that our service provider came up with
had all the components of the LAMP (Linux&reg;, Apache&reg;, MySQL&reg;, PHP ) stack in it:

The back-end component runs on Linux virtual machines (VM) and is implemented in PHP
(or in Python&reg; using Flask&reg; or Django&reg;). The system stores the nail designs
metadata on MySQL running on Amazon RDS and the actual images on an
Amazon EFS that is mounted by the application servers. Traffic to the
application servers is sent through an application load balancer with
health checks defined to forward customer traffic to only
functional instances. The use of auto-scaling group ensures scalability,
high availability, and elasticity of the infrastructure. The use of private
and public subnets, combined with tight security groups, plus AWS Shield DDoS
filtering serves as a virtual firewall for the VMs, preventing malicious
traffic from obtaining direct access to the VMs and data.

{{<img src="lamp-stack-image-1.png" title="" alt="">}}

The design looked very good, but before giving it a go, I decided to check
how well it conforms to my technical and business requirements. Here is the mapping:

| Requirement | Available | Comments |
| --- | --- | --- |
| Support for Sign Up, Sign In, Sign Out | No | Requires a custom solution |
| Web and mobile support | No | Requires different versions for web and mobile. No support for conflict resolution and offline functionality |
| Persistent data | Yes | Amazon EFS Performance and cost will be a challenge, scalability is ok |
| Encryption of data at rest and in transit | Yes | Certificates on ALB Encryption of EBS volumes and Amazon EFS |
| High availability | Yes | Multi-AZ deployment of Amazon EC2, Amazon EFS, and Amazon RDS; ASG and ALB with health checks |
| Fine-grained access control to the images | No | Will be implemented as part of the application running on Amazon EC2 |
| Minimum to zero maintenance | No | Amazon EC2 instances, instance limits, vertical scaling if image processing is involved |
| Low development and app lifecycle cost | No | A lot of business and user management logic should be implemented; monolith approach with long lifecycle |
| Infrastructure cost | ~$400/month | |

Needless to say, I asked my service provider to come up with a better solution
before moving to the implementation stage. I had never budgeted $400 a month
for infrastructure costs, nor was I prepared to have an IT department to
handle the maintenance of the VMs hosting my site. Scaling is
slow. It takes time to bring up new instances, install packages, and perform
configuration. Also, there are no analytics in this proposal, meaning I have no
edge against my competitors.

### Design option 2: Containers

The second proposal was quick to follow. My service provider assured me that
most businesses, from small to enterprise-level, are going with microservices
and containerization nowadays, and the provider can develop my application by
using the microservices approach easily. Moreover, the new design addresses
my concerns of a long application lifecycle and high infrastructure cost
by potentially splitting the application into multiple components and moving
image storage from expensive AWS EFS to very cost-efficient AWS S3 object
storage. Moreover, lightweight containers would scale faster and better
address peak traffic on my site. Just think of the Christmas
holidays&mdash;everyone will be looking for a fresh new manicure at the same time.

AWS S3 hosts the client-side code, assets, and nail-design images, the
website backend logic runs on AWS ECS, and DynamoDB stores the image metadata along with
other persistent data. This design leveraged AWS-managed services and aligns
with the modern approach to application development.

{{<img src="lamp-stack-image-2.png" title="" alt="">}}

My site running in containers sounded like a great idea, and I was positive
we hit gold this time. Prepared to see my requirements fully covered, I went
into the mapping exercise again to visualize the benefits of containerization
for websites like mine that have little logic and are mainly built around
user authentication and content hosting.

| Requirement | Available | Comments |
| --- | --- | --- |
| Support for Sign Up, Sign In, Sign Out | No | Requires a custom solution |
| Web and mobile support | No | Requires different versions for web and mobile. No support for conflict resolution and offline functionality |
| Persistent data | Yes | Amazon S3, Amazon DynamoDB, and Amazon Elasticsearch Service |
| Encryption of data at rest and in transit | Yes | Certificates on ALB Encryption of EBS volumes and EFS |
| High availability | Yes | Multi-AZ deployment of Amazon ECS |
| Fine-grained access control to the images | No | Will be implemented as part of the application running in containers on Amazon ECS |
| Minimum to zero maintenance | No | Amazon EC2 instances and containers maintenance, high ramp up cost and expensive professionals to deal with a containerized site |
| Low development and app lifecycle cost | No | Will need to hire professionals to implement FE, BE, and infrastructure |
| Infrastructure cost | ~$200/month | |

The result of this requirements mapping was unexpectedly disappointing.
Containerization did not look like the best approach in my case. The main
arguments against it are different compared to the VMs approach, but the
outcome remained the same. I had to continue looking for a better solution.

### Design option 3: Serverless with AWS API gateway

The serverless approach to modern web and mobile applications design has
become a standard for cloud-based solutions. The low operational overhead
and the relatively short ramp-up time (compare the time to learn a
serverless framework to the time needed to understand Kubernetes&reg; architecture,
networking, service mesh, monitoring tools, and containers) make this approach
highly attractive for small businesses. In addition, high development
speed&mdash;combined with a cost-effective application of a *pay as you go* model
and a full abstraction of the infrastructure layer&mdash; make this approach a go-to
solution whenever applicable.

Considering the preceding details, it came as no surprise that this proposed design
capitalized on the serverless approach to modern application development in
AWS. Thanks to this approach, many of my requirements were satisfied right away:

- No servers to maintain
- High availability and elasticity built-in
- Pay for value, not for the idle capacity
- Scale with use

{{<img src="lamp-stack-image-3.png" title="" alt="">}}

The back-end logic running in containers fronted by a load balancer (AWS ALB) is
replaced by a combination of AWS API Gateway and Lambda, used to access
metadata and user-generated content in Amazon DynamoDB. This change provided
substantial cost benefits and eliminated the main concern of the containers
approach, namely infrastructure maintenance complexity and a high ramp-up
bar. It came with additional advantages:

- AWS API Gateway integration with Amazon Cognito user pools allowed the use of
  AWS-managed service for users authentication and authorization.
- Modern application lifecycle with multiple environments is available in AWS API Gateway.
- Monitoring and logging are provided by AWS Cloudwatch.
- Latency was improved thanks to the caching mechanism in AWS API Gateway.

The requirements mapping based on a serverless approach with AWS API Gateway
and Lambda follows:

| Requirement | Available | Comments |
| --- | --- | --- |
| Support for Sign Up, Sign In, Sign Out | Yes | Amazon Cognito integrated with AWS API Gateway |
| Web and mobile support | No | Requires different versions for web and mobile. No support for conflict resolution and offline functionality |
| Persistent data | Yes | Amazon S3, Amazon DynamoDB, and Amazon Elasticsearch Service |
| Encryption of data at rest and in transit | Yes | Certificates on ALB Encryption of EBS volumes and EFS |
| High availability | Yes | Through the use of AWS managed services |
| Fine-grained access control to the images | Yes | Amazon Cognito Identify Federation, Groups, and RBAC |
| Minimum to zero maintenance | Yes\* | Servers not used in the application infrastructure designs. \*Amazon Elasticsearch Service used for analytics, requires VMs maintenance |
| Low development and app lifecycle cost | Yes\* | \*FE and BE are treated as different parts of application |
| Infrastructure cost | ~$50/month | |

This approach looked perfect and satisfied both my technical and business
requirements, all at a cost of $50 a month. As a bonus, it included analytics
with an Amazon Elasticsearch Service cluster, automatic sentiment analysis of
customer responses to my designs with AWS Comprehend, and auto-moderation of
uploaded images by using Amazon Rekognition. Amazon SNS is used to send
notifications of inappropriate content upload attempts. I considered going
into the implementation stage with this option.

### Design option 4: Serverless with AWS Amplify and AWS AppSync

It turns out that I was not completely satisfied with Design Option 3, so I
asked for another version of the design that uses the latest AWS
services: AWS Amplify and AWS AppSync. The reasoning behind my request was
mostly my curiosity about a solution that supports multi-platform
backends and provides an ecosystem for integrated frontend and back-end
development.

The capabilities of AWS AppSync were too tempting.  Things such as:

- Support for multiple data sources in the same query
- Integration with anything in the universe through the use of AWS Lambda
- Native support of subscriptions
- Real-time updates and conflict resolutions
- Integration with Amazon Cognito for fine-grained access control to data sources

Implementing AWS AppSync resolvers might be a daunting task. Luckily, AWS Amplify
auto-generates the resolvers used by AWS AppSync to access data sources
such as Amazon DynamoDB and Amazon Elasticsearch Service in my case. In fact,
the AWS Amplify components already support most of the infrastructure pieces needed
by my application. Authentication, hosting for my static
website, object storage, Amazon DynamoDB tables, and Amazon Elasticsearch
Service for analytics are all glued together with AWS Lambda and event-driven
architecture. I was inclined to ask my service provider to give this new
approach a try. They came up with the following design:

{{<img src="lamp-stack-image-4.png" title="" alt="">}}

In the new design, AWS AppSync replaced the combination of AWS API Gateway and
AWS Lambda used for persistent data access, which eliminated a few
AWS Lambda functions from the previoius design.

The design remained mostly unchanged, but my service provider could dot
the i’s and cross the t’s in my list of the requirements at no extra cost. It
felt as if I had nothing to nitpick on anymore and had to accept their
work. The requirements matrix looked fully covered.

| Requirement | Available | Comments |
| --- | --- | --- |
| Support for Sign Up, Sign In, Sign Out | Yes | Amazon Cognito integrated with AWS API Gateway |
| Web and mobile support | Yes | AWS AppSync support for web and mobile applications |
| Persistent data | Yes | Amazon S3, Amazon DynamoDB, and Amazon Elasticsearch Service |
| Encryption of data at rest and in transit | Yes | Certificates on ALB Encryption of EBS volumes and EFS |
| High availability | Yes | Through the use of AWS managed services |
| Fine-grained access control to the images | Yes | Amazon Cognito Identify Federation, Groups, and RBAC |
| Minimum to zero maintenance | Yes\* | Servers not used in the application infrastructure designs. \*Amazon Elasticsearch Service used for analytics, requires VMs maintenance |
| Low development and app lifecycle cost | Yes | FE and BE development through AWS Amplify ecosystem |
| Infrastructure cost | ~$50/month | |


### Conclusion

You can design a simple web application on AWS in many different ways,
and the preceding list is not exhaustive (think AWS Fargate and AWS Amplify with
AWS API Gateway, for example). The ever-changing landscape of AWS services
and their capabilities encourages us to review the designs that many
considered industry standards just a couple of years ago. Therfore, we should
carefully pick the right approach from the many options that are currently
available, test it out, and be ready to go back to the drawing board if the
chosen path does not live up to our expectations.

In a future post, I will dive into this website’s data flows that use
AWS ML services (Amazon Comprehend and Amazon Rekognition) to offload the
mundane tasks of site moderation and user comments review to AWS managed
services. I will also show how you can use the processed user-generated content
to drive actionable insights using Amazon Elasticsearch Service dashboards.

<a class="cta red" id="cta" href="https://www.rackspace.com/onica">Learn more about Onica services.</a>

Use the Feedback tab to make any comments or ask questions. You can also click
**Sales Chat** to [chat now](https://www.rackspace.com/) and start the conversation.
